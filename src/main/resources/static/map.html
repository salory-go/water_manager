<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Map with Vue.js</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./layui-v2.9.3/layui/css/layui.css">
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
<div id="app">
  <el-menu class="el-menu-demo" mode="horizontal" class="flex">
    <el-menu-item index="1"><a href="1.html">测站基本信息表</a></el-menu-item>
    <el-menu-item index="2"><a href="2.html">河流基本信息表</a></el-menu-item>
    <el-menu-item index="3"><a href="3.html">测站详细信息表</a></el-menu-item>
    <el-menu-item index="4"><a href="map.html">测站地理可视化</a></el-menu-item>
  </el-menu>
  <div id="map" style="width: 100%; height: 600px;"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="./js/element.js"></script>
<script>
  new Vue({
    el: '#app',
    data: {
      map: null,
      markers: []
    },
    mounted() {
      this.initMap();
    },
    methods: {
      initMap() {
        // 初始化地图，并设置中心点和缩放级别
        this.map = L.map('map').setView([30, 110], 5);

        // 添加OpenStreetMap的图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(this.map);

        fetch('http://localhost:8080/CZ')
                .then(response => response.json())
                .then(data => {
                  data.forEach((sdata, i) => {
                    this.markers.push({
                      lat: sdata.w,
                      lng: sdata.e,
                      message: sdata.name,
                      code: sdata.code
                    })
                  });
                  console.log(this.markers[0].lat);
                  this.markers.forEach(marker => {
                    let mark = L.marker([marker.lat, marker.lng]).addTo(this.map);
                    mark.bindPopup(marker.message);
                    mark.on('mouseover', function (e) {
                      this.openPopup();
                    });
                    mark.on('mouseout', function (e) {
                      this.closePopup();
                    });
                    mark.on('click', e => {
                      // 可以改成跳转到只查询一条信息的表格上
                      this.turn(marker);
                    });
                    let circle = L.circle([marker.lat, marker.lng], {
                      color: 'red',
                      fillColor: '#f03',
                      fillOpacity: 0.5,
                      radius: 20
                    }).addTo(this.map);
                  });
                })
                .catch(error => console.error('Error fetching data:', error));
      },
      turn(marker) {
        console.log(marker);
        // window.location.href = `1.html`;
        this.$confirm('将跳转回测站管理表', '提示', {
          confirmButtonText: '是的',
          cancelButtonText: '算了'
        }).then(() => {
          window.location.href = `1.html`;
        }).catch(() => {
        });
      }
    }
  });
</script>
</body>
</html>
